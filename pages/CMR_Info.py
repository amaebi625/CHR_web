# cmr_info.py

# pages/cmr_info.py
import os
import streamlit as st
import base64

def set_background(image_path):
    with open(image_path, "rb") as f:
        data = base64.b64encode(f.read()).decode()

    css = f"""
    <style>
    .stApp {{
        background: 
            linear-gradient(rgba(250, 245, 255, 0.4), rgba(250, 245, 255, 0.4)),
            url("data:image/png;base64,{data}");
        background-size: cover;
        background-position: center;
        background-attachment: fixed;
    }}
    </style>
    """
    st.markdown(css, unsafe_allow_html=True)
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
bg_path = os.path.join(BASE_DIR, "..", "image", "cmr_bg.png")
set_background(bg_path)
st.markdown("""
<style>
/* è®¾ç½®æ­£æ–‡æ®µè½æ–‡å­—å­—ä½“å¤§å°å’ŒåŠ ç²— */
div[data-testid="stMarkdownContainer"] p {
    font-size: 1.05rem;
    font-weight: 700;
    color: #3B2B4F;
    line-height: 1.25;
}
/* å…¨å±€ Markdown æ®µè½ä¸åˆ—è¡¨é¡¹æ–‡å­—é¢œè‰²ï¼ˆå†’å·åæ–‡å­—ï¼‰ */
.markdown-text-container p,
.markdown-text-container li {
    color: rgba(70, 45, 105, 0.95) !important;  /* æ·±ç´«è‰²ï¼Œæ¥è¿‘é»‘å­— */
    font-weight: 700;
}
/* è®¾ç½® blockquote çš„æ ·å¼ï¼ˆ> å¼•ç”¨éƒ¨åˆ†ï¼‰ */
div[data-testid="stMarkdownContainer"] blockquote {
    font-size: 1.05rem;
    color: #4C3F5A;
    background: rgba(240,240,250,0.4);
    padding: 1rem 1rem;
    border-left: 4px solid #AAA3D0;
    border-radius: 5px;
}
/* ğŸŒ• ä¾§è¾¹æ èƒŒæ™¯è‰²ï¼ˆæµ…ç±³é»„ï¼‰ */
    section[data-testid="stSidebar"] {
        background-color: #fff9e5 !important;
        width: 300px !important; 
    }
    /* å¢å¤§å·¦ä¾§è¾¹æ æ–‡å­—å¤§å° */
    [data-testid="stSidebar"] .css-pkbazv, [data-testid="stSidebar"] .css-uc76bn,
    [data-testid="stSidebar"] a, [data-testid="stSidebar"] p, 
    [data-testid="stSidebar"] div, [data-testid="stSidebar"] span,
    [data-testid="stSidebar"] li, [data-testid="stSidebar"] ul,
    [data-testid="stSidebar"] .css-eczf16, [data-testid="stSidebar"] .css-jcn9zf {
        font-size: 26px !important; /* å­—ä½“å¤§å°ä»18pxå¢åŠ åˆ°26px */
        font-weight: 500 !important;
        color: #99c8f0!important;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.7) !important;
    }
    
    /* å¢å¼ºè¾¹æ é¡¹ç›®çš„æ‚¬åœæ•ˆæœ */
    [data-testid="stSidebar"] a:hover, [data-testid="stSidebar"] li:hover {
        background-color: rgba(255,255,255,0.2) !important;
        border-radius: 5px !important;
        color: #ffffff !important;
    }
</style>
""", unsafe_allow_html=True)
# é¡µé¢é…ç½®
st.set_page_config(page_title="CMR ç§‘æ™®æŒ‡å—", page_icon="ğŸ“–", layout="wide")
st.markdown("""
<style>
.main-title {
        color: #e63946;
        font-size: 2.5rem;
        text-align: center;
        margin-bottom: 0.5rem;
    }
</style>
""", unsafe_allow_html=True)

# ==============================
# æ¿å—1ï¼šä»€ä¹ˆæ˜¯ CMRï¼ˆå¿ƒè„ç£å…±æŒ¯æˆåƒï¼‰
# ==============================
st.markdown("<h1 class='main-title'>ğŸ«€ å¿ƒè„ç£å…±æŒ¯æˆåƒï¼ˆCMRï¼‰ç§‘æ™®</h1>", unsafe_allow_html=True)
st.markdown("---")
st.markdown("## ä»€ä¹ˆæ˜¯ CMRï¼Ÿ")
st.markdown("""
å¿ƒè¡€ç®¡ç£å…±æŒ¯æˆåƒï¼ˆCardiac Magnetic Resonanceï¼ŒCMRï¼‰æ˜¯ä¸€é¡¹åŸºäº MRI çš„**é«˜ç²¾åº¦ã€æ— ç”µç¦»è¾å°„çš„å¿ƒè„æˆåƒæŠ€æœ¯**ï¼Œè¢«èª‰ä¸ºå¿ƒè„åŠŸèƒ½ä¸ç»“æ„è¯„ä¼°çš„â€œé‡‘æ ‡å‡†â€ã€‚

- **éä¾µå…¥æ€§ + é«˜åˆ†è¾¨ç‡**ï¼šæ— éœ€å¯¼ç®¡ã€ä¸ä¾èµ– X å°„çº¿ï¼Œèƒ½å¤Ÿæ¸…æ™°æ˜¾ç¤ºå¿ƒè‚Œè½®å»“ã€å¿ƒè…”ã€è¡€æµç­‰ç»†èŠ‚ï¼›
- **åŠŸèƒ½ + ç»„ç»‡è¯„ä¼°**ï¼šé€šè¿‡ cine åŠ¨æ€åºåˆ—æµ‹é‡å°„è¡€åˆ†æ•°ï¼ˆEFï¼‰ã€è¡€å®¹é‡ï¼›æ™šæœŸå¢å¼ºï¼ˆLGEï¼‰ã€T1/T2 mapping å¯è¯†åˆ«å¿ƒè‚Œç‚ã€çº¤ç»´åŒ–ã€ç˜¢ç—•ç­‰ç—…ç†å˜åŒ–ï¼›
- **å¤šç§åºåˆ—ç»„åˆ**ï¼šåŒ…æ‹¬äº®-é»‘è¡€åºåˆ—ã€çŒæ³¨åºåˆ—ã€4D-flow ç­‰ï¼Œå¯è¯„ä¼°è§£å‰–ã€çŒæ³¨ã€è¿åŠ¨ä¸åº”å˜çŠ¶æ€ï¼›
- **å¹¿æ³›ä¸´åºŠåº”ç”¨**ï¼šç”¨äºæ‰©å¼ å‹/è‚¥åšå‹å¿ƒè‚Œç—…ã€å† å¿ƒç—…ã€å…ˆå¤©æ€§å¿ƒè„ç—…ã€å¿ƒè‚Œç‚ç­‰ç–¾ç—…çš„æ—©æœŸæ£€æµ‹ä¸ç–—æ•ˆè¯„ä¼°ã€‚

> **CMRçš„åŠŸèƒ½å’Œä¼˜åŠ¿ï¼š**  
> â€¢ CMR å¯æµ‹é‡å¿ƒè„å°„è¡€åˆ†æ•°ã€è¡€æµåŠ¨åŠ›å­¦å’Œç»„ç»‡ç‰¹æ€§ï¼›  
> â€¢ Cine åºåˆ—æä¾›æ¯ä¸ªå¿ƒåŠ¨å‘¨æœŸçš„åŠ¨æ€å›¾åƒï¼›  
> â€¢ LGE ç”¨äºæ£€æµ‹å¿ƒè‚Œç˜¢ç—•ï¼ŒT1/T2 mapping ç”¨äºè¯Šæ–­ç‚ç—‡æˆ–çº¤ç»´åŒ–ï¼›  
> â€¢ æ— ç”µç¦»è¾å°„ï¼Œé€‚åˆé‡å¤æ£€æµ‹ã€‚

""")
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
IMG_PATH = os.path.join(BASE_DIR, "..", "image", "cmr.jpg")
st.image(
    IMG_PATH, 
    caption="å¿ƒè„ CMR æ¨ªæ–­é¢è§£å‰–å›¾ç¤ºï¼Œå·¦å¿ƒå®¤ (LV)ã€å³å¿ƒå®¤ (RV)ã€å¿ƒæˆ¿ç­‰ç»“æ„æ¸…æ™°å¯è§",
     width=600
)
# ==============================
# æ¿å—2ï¼šåŒ»å­¦åˆ†åŒºä¸åŠŸèƒ½ç§‘æ™®
# ==============================
st.markdown("---")
st.markdown("## åŒ»å­¦åˆ†åŒºä¸åŠŸèƒ½ç§‘æ™®")
st.markdown("""
å† å¿ƒç—…çš„æœ¬è´¨æ˜¯å† çŠ¶åŠ¨è„‰ç²¥æ ·ç¡¬åŒ–æ‰€å¯¼è‡´çš„**å¿ƒè‚Œä¾›è¡€ä¸è¶³**ï¼Œå…¶å…¸å‹åæœåŒ…æ‹¬ï¼š

- å¿ƒè‚Œç¼ºè¡€ï¼ˆIschemiaï¼‰ï¼›
- å¿ƒè‚Œæ¢—æ­»ï¼ˆMyocardial Infarction, MIï¼‰ï¼›
- å¿ƒè‚Œé‡æ„ä¸æ”¶ç¼©åŠŸèƒ½éšœç¢ï¼›
- å¿ƒåŠ›è¡°ç«­ï¼ˆHeart Failureï¼‰ç­‰ã€‚

å† å¿ƒç—…çš„å¿ƒè‚Œä¾›è¡€ä¸è¶³å°†å¼•å‘ä¸€ç³»åˆ—å¿ƒè‚Œç»“æ„ä¸åŠŸèƒ½çš„å˜åŒ–ï¼Œè€Œè¿™äº›å˜åŒ–åœ¨å½±åƒä¸Šæœ‰ç€æœ€ç›´è§‚çš„è¡¨ç°ï¼Œä¸”å¾€å¾€é›†ä¸­åœ¨ç‰¹å®šçš„è§£å‰–åŒºåŸŸï¼Œéœ€è¦ç²¾å‡†çš„è¯†åˆ«ä¸åˆ†å‰²ã€‚

| åŒºåŸŸ | è§£å‰–ä½ç½® | ç›‘æµ‹åŠŸèƒ½ |
|------|----------|-----------|
| **å·¦å¿ƒå®¤ï¼ˆLVï¼‰** | ä¸»åŠ¨è„‰æµå‡ºè…” | åæ˜ å¿ƒè„æ³µè¡€åŠŸèƒ½ |
| **å³å¿ƒå®¤ï¼ˆRVï¼‰** | è¿é€šè‚ºå¾ªç¯ | è¯„ä¼°è‚ºåŠ¨è„‰é«˜å‹ã€å³å¿ƒåŠŸèƒ½è¡°å‡ |
| **å¿ƒè‚Œå£ï¼ˆMYOï¼‰** | åŒ…è£¹å¿ƒè…”çš„å¿ƒè‚Œå±‚ | ç›‘æµ‹å¢™åšã€çº¤ç»´åŒ–ã€ç‚ç—‡ç­‰å¿ƒè‚Œç»“æ„å˜åŒ– |

CMRæ˜¯ç›®å‰è¯„ä¼°å† å¿ƒç—…å¿ƒè‚ŒæŸä¼¤çš„é‡‘æ ‡å‡†å½±åƒæ‰‹æ®µä¹‹ä¸€ï¼Œå…¶ç»“æ„åˆ†å‰²æ˜¯å®Œæˆæ‰€æœ‰**ä¸‹æ¸¸å®šé‡**åˆ†æçš„å‰ç½®ä»»åŠ¡ï¼š

| ä¸‹æ¸¸åˆ†ææŒ‡æ ‡ | ä¾èµ–åŒºåŸŸ | åŒ»å­¦æ„ä¹‰ |
| --------------------------- | -------- | ------------------------ |
| èˆ’å¼ æœ«ä½“ç§¯/æ”¶ç¼©æœ«ä½“ç§¯(EDV/ESV)    | LV  | åæ˜ å¿ƒè…”å®¹é‡å˜åŒ–                 |
| æ¯æè¾“å‡ºé‡(SV)                   | LV  | æ¯æ¬¡æ”¶ç¼©æ³µå‡ºçš„è¡€é‡ï¼ŒSV = EDV - ESV |
| å°„è¡€åˆ†æ•°(EF)                    | LV  | å¿ƒè„æ³µè¡€èƒ½åŠ›æ ¸å¿ƒæŒ‡æ ‡ï¼ŒEF = SV / EDV |
| å³å¿ƒå®¤èˆ’å¼ æœ«/æ”¶ç¼©æœ«ä½“ç§¯(RVEDV/RVESV) | RV  | è¯„ä¼°è‚ºå¾ªç¯å®¹é‡å˜åŒ–                |
| å³å¿ƒå®¤å°„è¡€åˆ†æ•°(RVEF)               | RV  | å³å¿ƒæ³µè¡€åŠŸèƒ½è¯„ä¼°æŒ‡æ ‡               |
| å¿ƒè‚Œè´¨é‡                        | MYO | ç”¨äºåˆ¤æ–­å¿ƒè‚Œè‚¥åšã€å¿ƒå®¤é‡æ„            |
| å¿ƒè‚Œå£åšä¸è¿åŠ¨åˆ†æ                   | MYO | ç”¨äºè¯†åˆ«å¿ƒè‚Œæ¢—æ­»åŒºåŸŸã€åˆ†æè¿åŠ¨åŒæ­¥æ€§       |


""")

# ==============================
# æ¿å—3ï¼šæ•°æ®ä¸æ¨¡å‹æ¶æ„
# ==============================
st.markdown("---")
st.markdown("## æ•°æ®æ¥æºä¸æ¨¡å‹æ¶æ„")
st.markdown("""
### ğŸ“š æ•°æ®æ¥æº
æœ¬ç³»ç»ŸåŸºäº ACDCï¼ˆAutomated Cardiac Diagnosis Challengeï¼‰å…¬å¼€æ•°æ®é›†æ„å»ºå¹¶è®­ç»ƒï¼Œæ•°æ®å…±åŒ…æ‹¬ 150 ä¾‹ Cine CMR æ£€æŸ¥æ ·æœ¬ï¼ˆ100 ä¾‹è®­ç»ƒ + 50 ä¾‹æµ‹è¯•ï¼‰ï¼Œè¦†ç›–äº”ç§ä¸»è¦ä¸´åºŠç±»å‹ï¼š
- æ­£å¸¸å¿ƒè„ï¼ˆNormalï¼‰ï¼›
- å¿ƒè‚Œæ¢—æ­»ï¼ˆMyocardial Infarctionï¼‰ï¼›
- æ‰©å¼ å‹å¿ƒè‚Œç—…ï¼ˆDilated Cardiomyopathyï¼‰ï¼›
- è‚¥åšå‹å¿ƒè‚Œç—…ï¼ˆHypertrophic Cardiomyopathyï¼‰ï¼›
- å³å¿ƒå®¤å¼‚å¸¸ï¼ˆAbnormal Right Ventricleï¼‰ã€‚

### ğŸ”§ æ¨¡å‹ç»“æ„è®¾è®¡

æœ¬æ¨¡å‹åœ¨æ ‡å‡† Uâ€‘Net æ¶æ„åŸºç¡€ä¸Šå»ºç«‹äº†ä¸€ç§è½»é‡åŒ–çš„ Encoderâ€“Decoder ç½‘ç»œï¼Œå…¼é¡¾è¡¨è¾¾èƒ½åŠ›ä¸è®­ç»ƒæ•ˆç‡ï¼Œç‰¹åˆ«é€‚ç”¨äº 2D CMR å›¾åƒçš„è¯­ä¹‰åˆ†å‰²ä»»åŠ¡ã€‚æ•´ä½“æ¨¡å‹æ¶æ„å¦‚ä¸‹ï¼š

| æ¨¡å—       | æ“ä½œæ„æˆ                     | é€šé“æ•°å˜åŒ–     | è¾“å‡ºå°ºå¯¸ï¼ˆç¤ºä¾‹ï¼‰ |
|------------|------------------------------|----------------|------------------|
| è¾“å…¥å±‚     | å•é€šé“ CMR å›¾åƒ              | 1              | 256Ã—256          |
| ç¼–ç å™¨ 1   | Conv2DÃ—2 + BN + ReLU + MaxPool | 32 â†’ 64        | 128Ã—128          |
| ç¼–ç å™¨ 2   | Conv2DÃ—2 + BN + ReLU + MaxPool | 64 â†’ 128       | 64Ã—64            |
| ç¼–ç å™¨ 3   | Conv2DÃ—2 + BN + ReLU + MaxPool | 128 â†’ 256      | 32Ã—32            |
| ç“¶é¢ˆå±‚     | Conv2D + BN + ReLU           | 256 â†’ 512      | 16Ã—16            |
| è§£ç å™¨ 1   | UpSampling + skip + Conv2DÃ—2 | 512 â†’ 256      | 32Ã—32            |
| è§£ç å™¨ 2   | UpSampling + skip + Conv2DÃ—2 | 256 â†’ 128      | 64Ã—64            |
| è§£ç å™¨ 3   | UpSampling + skip + Conv2DÃ—2 | 128 â†’ 64       | 128Ã—128          |
| è¾“å‡ºå±‚     | Conv2D + Softmax             | 64 â†’ 4         | 256Ã—256Ã—4        |

æ­¤ç½‘ç»œé€šè¿‡å¤šå°ºåº¦ä¿¡æ¯èåˆä¸ç©ºé—´åˆ†è¾¨ç‡æ¢å¤æœºåˆ¶ï¼Œåœ¨ä¿æŒè¾ƒå°æ¨¡å‹è§„æ¨¡çš„åŒæ—¶ï¼Œæœ‰æ•ˆæå‡äº†åˆ†å‰²ç²¾åº¦ä¸æ¨¡å‹æ¨ç†æ•ˆç‡ã€‚

""")


# ==============================
# æ¿å—4ï¼šæ¨¡å‹æ€§èƒ½ï¼ˆDice æŒ‡æ ‡è¡¨ç°ï¼‰
# ==============================
st.markdown("---")
st.markdown("## å¤šç»´åº¦æ¨¡å‹æ€§èƒ½å±•ç¤º")
st.markdown("""
æ¨¡å‹åœ¨ ACDC è®­ç»ƒé›†ä¸Šå®Œæˆè®­ç»ƒåï¼Œé’ˆå¯¹ç‹¬ç«‹æµ‹è¯•é›†è¿›è¡Œäº†æ€§èƒ½è¯„ä¼°ã€‚ä¸»è¦åˆ†å‰²æŒ‡æ ‡è¡¨ç°å¦‚ä¸‹æ‰€ç¤ºï¼š

| æŒ‡æ ‡åç§° (Metric) | æ•°å€¼ (Value) | è¯„ä»·è¯´æ˜ |
|------------------|---------------|-----------|
| **Dice ç³»æ•° (Dice Coefficient)** | 0.9247 | âœ… é¢„æµ‹åŒºåŸŸä¸çœŸå®åŒºåŸŸé«˜åº¦ä¸€è‡´ |
| **Jaccard æŒ‡æ•° (IoU)** | 0.8610 | âœ… é¢„æµ‹æ©ç ä¸çœŸå®æ©ç æœ‰è¾ƒå¼ºç©ºé—´é‡å æ€§ |
| **Precision (æŸ¥å‡†ç‡)** | 0.9473 | âœ… è¯¯æŠ¥ç‡ä½ï¼Œé¢„æµ‹ç»“æœå¯é æ€§å¼º |
| **Recall (æŸ¥å…¨ç‡)** | 0.9390 | âœ… æ¼æ£€ç‡ä½ï¼Œæ¨¡å‹å…·å¤‡è‰¯å¥½æ•æ„Ÿæ€§ |
| **Accuracy (æ€»ä½“åƒç´ å‡†ç¡®ç‡)** | 0.9954 | âœ… æ•´ä½“åˆ†ç±»æ•ˆæœæä½³ |

ç»“æœè¡¨æ˜ï¼Œæœ¬æ¨¡å‹åœ¨æ§åˆ¶è®¡ç®—å¤æ‚åº¦çš„åŒæ—¶ï¼Œæ€§èƒ½èƒ½å¤Ÿåœ¨CMRåˆ†å‰²ä»»åŠ¡ä¸­è¾¾åˆ°é«˜ç²¾åº¦æ°´å¹³ï¼Œå…·æœ‰å®ç”¨ä»·å€¼ã€‚
""")

# ==============================
# è¿”å›æŒ‰é’®
# ==============================
st.markdown("""
<div style="text-align:center; margin:40px 0;">
  <a href="/cmr" target="_self">
    <button style="
      background:#0072C6;
      color:white;
      padding:14px 36px;
      font-size:16px;
      border:none;
      border-radius:8px;
      cursor:pointer;
      box-shadow:0 3px 10px rgba(0,0,0,0.2);
    ">ğŸ”™ è¿”å›åˆ†å‰²é¡µé¢</button>
  </a>
</div>
""", unsafe_allow_html=True)
